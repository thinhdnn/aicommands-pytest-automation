---
alwaysApply: true
---
# Cursor AI Rules - Playwright + pytest Test Automation Framework

## Project Overview
This is a **Playwright + pytest test automation framework** for a VueJS application using centralized locators, component-based architecture, and data-driven testing patterns.

## üö´ MANDATORY Rules (Must Follow)

### 1A. Import & Function Placement (Python files)
- ‚úÖ **ALWAYS add new imports at the very top of the file** (following the standard import order in this guide)
- ‚úÖ **ALWAYS add new functions at the very end of the file** (after all existing functions/classes)
- ‚ùå **NEVER insert imports or functions in the middle of the file**

This applies to ALL Python files in the project. Agent must always enforce this rule when generating or editing code.

### 1. No Hardcoded URLs
- ‚ùå **NEVER** hardcode URLs: `"http://..."` or `"https://..."`
- ‚úÖ **ALWAYS** use environment config: `config.base_url + "/users"`
- ‚úÖ Load from environment variables or config files

### 2. Imports Must Be at Top
- ‚ùå **NEVER** import inside functions (unless avoiding circular imports with comment)
- ‚úÖ **ALWAYS** put all imports at file top in specific order (see 1A)

### 3. No Hardcoded Selectors
- ‚ùå **NEVER** use: `page.fill("#email", "test@test.com")`
- ‚úÖ **ALWAYS** use centralized locators: `page.fill(AuthLocators.EMAIL_INPUT, email)`

### 4. Always Use English Comments
- ‚úÖ **ALWAYS** write comments in English only
- ‚ùå **NEVER** use other languages for comments or documentation

## Architecture Rules

### üéØ Core Patterns (MANDATORY)
- **Centralized Locators**: Never hardcode selectors - use `locators/` classes
- **Feature-Based Testing**: Organize tests by business features, not pages
- **Fluent Testing Pattern**: Use fluent helpers with method chaining for readable tests
- **Component Architecture**: Use reusable components from `components/`
- **Environment Configuration**: Load settings from `config/environment.py`
- **Data-Driven Tests**: Use `utils/data_loader.py` for test data
- **Fixtures for Logic**: Fixtures handle state management, helpers are pure utilities

### üö´ Anti-Patterns (FORBIDDEN)
```python
# ‚ùå NEVER do these:
page.fill("#email", "test@test.com")           # Hardcoded selectors
page.goto("http://localhost:3000")       # Hardcoded URLs
class LoginPage: pass                          # Page Object Pattern
time.sleep(5)                                  # Use proper waits
```

## Code Generation Standards

### MANDATORY Import Order
```python
"""Feature description tests using Fluent pattern and centralized locators"""
# 1. Standard library imports
import pytest
from typing import Dict, Any

# 2. Playwright imports
from playwright.sync_api import expect

# 3. Locators imports (ALWAYS FIRST in project imports)
from locators.auth_locators import AuthLocators
from locators.user_locators import UserLocators
from locators.common_locators import CommonLocators

# 4. Fluent helpers imports
from utils.fluent_helpers import fluent_test, FluentFormHelper
from utils.fluent_api import fluent_api_test

# 5. Components imports
from components.form_component import FormComponent
from components.navigation_component import NavigationComponent
from components.table_component import TableComponent

# 6. Configuration and utilities imports
from config.environment import get_config, is_feature_enabled
from utils.data_loader import get_test_user_by_role, TestDataLoader
```

### Section Comment Refactor Rule (MANDATORY)
When refactoring or creating new tests, MUST add or update section comments using the following standard:
- `# === PRECONDITION ===`
- `# === ACTION ===`
- `# === VERIFICATION ===`
- Or other workflow-appropriate sections, e.g. `# === LOGIN WORKFLOW ===`, `# === LOGOUT WORKFLOW ===`

If a code file does not have section comments, MUST automatically insert these comments at the correct logical position for each step in the test.

Refactor example:
```python
def test_something(self):
    # === PRECONDITION ===
    # setup code...

    # === ACTION ===
    # main action...

    # === VERIFICATION ===
    # assert...
```

### Test Structure Template (MANDATORY)
```python
class TestFeatureName:
    """Test business feature functionality using Fluent pattern"""
    
    def test_business_workflow_description(self, page, admin_user):
        """Test [specific business scenario] workflow"""
        
        # === SETUP ===
        config = get_config()
        test = fluent_test(page, "Business Workflow Test")
        
        # Feature flag check
        if not is_feature_enabled("feature_name"):
            pytest.skip("Feature not enabled")
        
        # === NAVIGATION ===
        (test.given()
         .navigate_to(config.base_url + "/section")
         .wait_for_element(FeatureLocators.CONTAINER))
        
        # === ACTION ===
        (test.when()
         .click_element(FeatureLocators.ACTION_BUTTON)
         .fill_field(FeatureLocators.INPUT_FIELD, "test data"))
        
        # === VERIFICATION ===
        (test.then()
         .element(CommonLocators.SUCCESS_MESSAGE)
         .should_be_visible()
         .should_contain_text("Success"))
```

### Test Naming Convention (MANDATORY)
```python
# ‚úÖ CORRECT - Business-focused, descriptive
def test_admin_can_create_user_with_editor_role(self, page, admin_user):
def test_user_search_filters_by_department_and_status(self, page):
def test_bulk_delete_shows_confirmation_modal_before_deletion(self, page):

# ‚ùå WRONG - Too generic
def test_create_user(self, page):
def test_search(self, page):
def test_login_works(self, page):
```

### Component Usage (REQUIRED)
```python
# ‚úÖ Use existing components
form = FormComponent(page, UserLocators.USER_FORM)
form.fill_field("name", "John Doe")
form.submit_form()

table = TableComponent(page, UserLocators.USERS_TABLE)
assert table.has_row_with_text("John Doe")

# ‚úÖ Use auth fixtures for authentication workflows
admin_user = auth_session.login_user("admin", test_users)

# ‚úÖ Use Fluent test pattern
test = fluent_test(page, "User Creation Test")
(test.given()
 .navigate_to(config.base_url)
 .wait_for_element(UserLocators.CREATE_FORM))

# ‚ùå NEVER use raw Playwright when component/helper exists
page.fill("[data-testid='name']", "John")               # FORBIDDEN
page.click("[data-testid='submit']")                    # FORBIDDEN
```

### Environment & Data Patterns (MANDATORY)
```python
# ‚úÖ Environment configuration
config = get_config()
page.goto(config.base_url + "/users")

# ‚úÖ Test data loading
admin_user = get_test_user_by_role("admin")
test_data = TestDataLoader().get_test_scenarios("user_creation")

# ‚úÖ Feature flags
if is_feature_enabled("bulk_operations"):
    # Test bulk operations
    pass

# ‚ùå NEVER hardcode
page.goto("http://localhost:3000/users")                 # FORBIDDEN
page.fill(locator, "john@test.com")                      # FORBIDDEN
```

## üõ†Ô∏è Code Templates

### Locators Template:
```python
class FeatureLocators:
    """Feature-specific locators"""
    
    # Containers
    FEATURE_CONTAINER = "[data-testid='feature-container']"
    
    # Interactive elements
    ACTION_BUTTON = "[data-testid='action-btn']"
    
    # Dynamic locators
    @staticmethod
    def dynamic_element(identifier: str) -> str:
        return f"[data-testid='element-{identifier}']"
```

### Component Template:
```python
class FeatureComponent(BaseComponent):
    """Component for feature interactions"""
    
    def __init__(self, page, container_selector):
        super().__init__(page)
        self.container = container_selector
    
    def perform_action(self, data):
        """Perform specific business action"""
        # Use centralized locators
        self.page.click(f"{self.container} {FeatureLocators.ACTION_BUTTON}")
        self.wait_for_loading_to_finish()
```

## Project Context

### Target Application
- **VueJS frontend** with component-based UI
- **Role-based authentication** (admin, tester)
- **Dynamic routing** and SPA behavior
- **Home page auto-redirects** to login when not authenticated

### Key Test Areas
- User authentication and authorization
- User management (CRUD operations)
- Dashboard widgets and reporting
- Form interactions with validation
- Table operations (search, filter, sort)
- Modal dialogs and notifications

### Available Fixtures
- `authenticated_user(role)` - Generic user authentication
- `admin_user` - Pre-authenticated admin session
- `test_data_loader` - Data loading utilities
- `auth_helper` - Authentication operations

### Test Data Sources
- User credentials: `data/users.csv`
- Test scenarios: `data/test_data.json`
- Environment configs: `data/environments/{env}.json`

### Key Classes to Know
- `BaseComponent` - Base class for all components
- `FormComponent` - Generic form handling
- `TableComponent` - Table operations
- `NavigationComponent` - App navigation
- `TestDataLoader` - Test data management
- `EnvironmentConfig` - Environment settings
- `AuthHelper` - Authentication operations

## Selector Strategy (Priority Order)
1. `[data-testid='element-name']` - Preferred
2. `[data-action='action-name']` - For buttons
3. `button:has-text('Submit')` - Semantic
4. `input[type='email']` - Input types
5. **Avoid**: CSS classes, IDs, complex XPath

## Common Scenarios

### Authentication Tests
```python
def test_admin_login_workflow(self, page, test_users):
    test = fluent_test(page, "Admin Login Test")
    admin_creds = test_users.get("admin", {})
    
    (test.given()
     .navigate_to(config.base_url)
     .wait_for_element(AuthLocators.LOGIN_FORM))
    
    # Use auth fixture for authentication
    admin_user = auth_session.login_user("admin", test_users)
    
    (test.then()
     .element(AuthLocators.USER_ROLE_INDICATOR)
     .should_be_visible()
     .should_contain_text(admin_creds["name"]))
```

### User Management Tests
```python
def test_user_creation_workflow(self, page, admin_user):
    test = fluent_test(page, "User Creation Test")
    
    (test.given()
     .navigate_to(config.base_url + "/users")
     .wait_for_element(UserLocators.CREATE_BUTTON))
    
    (test.when()
     .click_element(UserLocators.CREATE_BUTTON)
     .fill_field(UserLocators.NAME_INPUT, test_data["name"])
     .fill_field(UserLocators.EMAIL_INPUT, test_data["email"])
     .click_element(UserLocators.SUBMIT_BUTTON))
    
    (test.then()
     .element(CommonLocators.SUCCESS_MESSAGE)
     .should_be_visible()
     .should_contain_text("User created successfully"))
```

### Data-Driven Tests
```python
@pytest.mark.parametrize("user_role", ["admin", "targeting.supervisor"])
def test_role_permissions(self, page, authenticated_user, user_role):
    test = fluent_test(page, f"Role Test - {user_role}")
    user = authenticated_user(user_role)
    
    (test.given()
     .navigate_to(config.base_url + "/dashboard")
     .wait_for_element(DashboardLocators.ROLE_INDICATOR))
    
    (test.then()
     .element(DashboardLocators.ROLE_INDICATOR)
     .should_contain_text(user["role"]))
```

## Generation Guidelines

When generating code:
1. **Always use centralized locators** from appropriate locators files
2. **Use Fluent test pattern** with method chaining for readable tests
3. **Use existing components** instead of raw Playwright calls
4. **Load configuration** from environment config
5. **Use test data loader** for external data
6. **Check feature flags** for conditional testing
7. **Include proper docstrings** with business scenarios
8. **Use appropriate fixtures** for test setup
9. **Follow naming conventions** for test methods
10. **Add proper assertions** with clear error messages
11. **Handle loading states** with fluent waits
12. **Use helpers for common workflows** (login, forms, etc.)

## üö´ Forbidden Patterns

### **ABSOLUTELY FORBIDDEN:**
```python
# ‚ùå FORBIDDEN - Hardcoded selectors
page.fill("#email", "test@test.com")
page.click("[data-testid='submit']")
page.wait_for_selector(".success")

# ‚ùå FORBIDDEN - Hardcoded URLs
page.goto("http://localhost:3000/login")
page.goto("https://staging.app.com/users")

# ‚ùå FORBIDDEN - Hardcoded test data
page.fill(locator, "john@test.com")
page.fill(locator, "password123")

# ‚ùå FORBIDDEN - Page Object Pattern
class LoginPage:
    def __init__(self, page):
        pass

# ‚ùå FORBIDDEN - Raw Playwright when component/helper exists
page.fill("[data-testid='name']", "John")  # Use FormComponent instead
page.click("tr:has-text('John') button")   # Use TableComponent instead

# ‚ùå FORBIDDEN - Magic numbers and timeouts
page.wait_for_selector(locator, timeout=30000)  # Use config timeout
time.sleep(5)  # Use proper waits

# ‚ùå FORBIDDEN - Unclear test names
def test_user(self, page):           # Too generic
def test_create(self, page):         # Not descriptive
def test_login_works(self, page):    # Not business-focused

# ‚ùå FORBIDDEN - Non-English comments
# ƒê√¢y l√† comment b·∫±ng ti·∫øng Vi·ªát  # NEVER DO THIS
# ËøôÊòØ‰∏≠ÊñáÊ≥®Èáä                     # NEVER DO THIS
```

## ‚úÖ Summary: Mandatory Checklist

### **Every test file MUST have:**
- [ ] Proper docstring describing feature coverage
- [ ] Correct import order (locators ‚Üí fluent helpers ‚Üí components ‚Üí config ‚Üí utils)
- [ ] Class docstring explaining test scope
- [ ] Method docstrings with business scenarios
- [ ] Centralized locators usage (NO hardcoded selectors)
- [ ] Fluent test pattern with method chaining
- [ ] Component usage for UI interactions
- [ ] Environment configuration for URLs/timeouts
- [ ] Test data loader for test data
- [ ] Proper fixtures usage
- [ ] Descriptive assertions with error messages
- [ ] Type hints for method parameters
- [ ] Pytest markers where appropriate
- [ ] Feature flag checks where applicable
- [ ] English-only comments and documentation

### **Every test method MUST follow:**
- [ ] Business-focused naming convention
- [ ] Setup ‚Üí Navigation ‚Üí Action ‚Üí Verification structure
- [ ] Clear section comments (=== SECTION ===)
- [ ] Fluent chaining for related actions
- [ ] Meaningful assertions with messages
- [ ] Proper error handling
- [ ] Feature flag checks where applicable

## Key Files to Reference
- `locators/auth_locators.py` - Authentication UI elements
- `locators/common_locators.py` - Shared UI elements
- `utils/fluent_helpers.py` - Fluent UI helpers and patterns
- `utils/fluent_api.py` - Fluent API testing helpers
- `components/base_component.py` - Base component functionality
- `fixtures/auth_fixtures.py` - Authentication fixtures
- `config/environment.py` - Environment configuration
- `utils/data_loader.py` - Test data management

## Philosophy
This framework prioritizes maintainability, reusability, and business-focused testing using Fluent patterns over traditional page-based automation approaches. Always write code that is:
- **Readable**: Clear business intent
- **Maintainable**: Centralized locators and components
- **Reusable**: Shared components and helpers
- **Robust**: Proper waits and error handling
- **Data-Driven**: External test data sources
- **Environment-Aware**: Configuration-based settings

